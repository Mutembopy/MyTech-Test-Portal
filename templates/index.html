<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechCorp Chat</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: radial-gradient(circle at 20% 20%, #74ebd5, #203a43, #2c5364);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #fff;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .navbar a {
            color: #fff;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .navbar a:hover {
            color: #aee1f9;
        }
        .container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            padding: 15px;
            border-radius: 12px;
            margin-right: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .sidebar h3 {
            margin: 0 0 15px;
            font-size: 1.2em;
            color: #fff;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            color: #fff;
        }
        .sidebar li:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .sidebar li.active {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            flex: 1;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }
        .message {
            margin: 12px 0;
            padding: 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.sent {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            margin-left: auto;
        }
        .message.received {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            margin-right: auto;
        }
        .message .sender {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 4px;
        }
        .message .timestamp {
            font-size: 0.75em;
            color: #ddd;
            margin-top: 6px;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        #message-input::placeholder {
            color: #ccc;
        }
        #message-input:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }
        #send-button {
            padding: 12px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #send-button:hover:not(:disabled) {
            background-color: #388e3c;
        }
        #send-button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }
        #typing-indicator {
            font-style: italic;
            color: #ccc;
            margin: 10px 0;
            text-align: center;
        }
        .group-form {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .group-form h3 {
            margin: 0 0 15px;
            font-size: 1.2em;
        }
        .group-form input,
        .group-form select {
            width: 100%;
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .group-form input::placeholder,
        .group-form select {
            color: #ccc;
        }
        .group-form button {
            width: 100%;
            padding: 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .group-form button:hover {
            background-color: #388e3c;
        }
        @media (max-width: 800px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{{ url_for('tech_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('profile') }}">Profile</a>
        <a href="{{ url_for('tech_logout') }}">Logout</a>
    </div>
    <div class="container">
        <div class="sidebar">
            <h3>Private Chats</h3>
            <ul id="private-chats">
                {% for tech in technicians %}
                    <li data-type="private" data-id="{{ tech[0] }}" data-name="{{ tech[1] }}">{{ tech[1] }}</li>
                {% endfor %}
            </ul>
            <h3>Group Chats</h3>
            <ul id="group-chats">
                {% for group in groups %}
                    <li data-type="group" data-id="{{ group[0] }}" data-name="{{ group[1] }}">{{ group[1] }}</li>
                {% endfor %}
            </ul>
            <div class="group-form">
                <h3>Create Group</h3>
                <form action="{{ url_for('create_group') }}" method="POST">
                    <input type="text" name="group_name" placeholder="Group Name" required>
                    <select name="members" multiple required>
                        {% for tech in technicians %}
                            <option value="{{ tech[0] }}">{{ tech[1] }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Create Group</button>
                </form>
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-box" id="chat-box">
                {% if messages %}
                    {% for msg in messages %}
                        <div class="message {{ 'sent' if msg.sender_id == user.id else 'received' }}">
                            <div class="sender">{{ msg.sender_name }}</div>
                            <div>{{ msg.message }}</div>
                            <div class="timestamp">{{ msg.timestamp }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div>Select a chat to start messaging.</div>
                {% endif %}
            </div>
            <div id="typing-indicator"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Type a message..." disabled>
                <button id="send-button" disabled>Send</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script>
        const socket = io();
        let user = { id: 0, name: 'Unknown' };
        let messages = [];
        
        // Check if data attributes are available in the DOM
        const userDataElement = document.getElementById('user-data');
        const messagesDataElement = document.getElementById('messages-data');
        
        try {
            // Use DOM-based data if available, otherwise use Jinja2-rendered data
            user = {% if user is defined and user is not none %}{{ user | tojson | safe }}{% else %}{ id: 0, name: 'Unknown' }{% endif %};
            messages = {% if messages is defined and messages is not none %}{{ messages | tojson | safe }}{% else %}[]{% endif %};
        } catch (e) {
            console.error('Error parsing JSON:', e);
            user = { id: 0, name: 'Unknown' };
            messages = [];
        }

        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const privateChats = document.querySelectorAll('#private-chats li');
        const groupChats = document.querySelectorAll('#group-chats li');
        let currentRoom = null;
        let currentType = null;
        let currentId = null;
        let currentName = null;

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function getPrivateRoomId(userId1, userId2) {
            return [userId1, userId2].sort().join('-');
        }

        function selectChat(type, id, name) {
            if (currentRoom) {
                socket.emit('leave', { room: currentRoom, user_name: user.name });
            }
            currentType = type;
            currentId = id;
            currentName = name;
            currentRoom = type === 'private' ? getPrivateRoomId(user.id, id) : `group-${id}`;
            socket.emit('join', { room: currentRoom, user_name: user.name });
            // Clear chat box
            chatBox.innerHTML = '';
            // Load relevant messages
            messages.forEach(msg => {
                if ((type === 'private' && msg.recipient_id && (msg.sender_id == user.id || msg.recipient_id == user.id) && (msg.sender_id == id || msg.recipient_id == id)) ||
                    (type === 'group' && msg.group_id == id)) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender_id == user.id ? 'sent' : 'received'}`;
                    messageDiv.innerHTML = `
                        <div class="sender">${msg.sender_name || 'Unknown'}</div>
                        <div>${msg.message}</div>
                        <div class="timestamp">${msg.timestamp}</div>
                    `;
                    chatBox.appendChild(messageDiv);
                }
            });
            if (!chatBox.innerHTML) {
                chatBox.innerHTML = '<div>No messages yet.</div>';
            }
            scrollToBottom();
            // Update active chat
            document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
            document.querySelector(`.sidebar li[data-id="${id}"][data-type="${type}"]`).classList.add('active');
            messageInput.disabled = false;
            sendButton.disabled = false;
            chatBox.dataset.chatName = name;
        }

        privateChats.forEach(chat => {
            chat.addEventListener('click', () => {
                selectChat('private', chat.dataset.id, chat.dataset.name);
            });
        });

        groupChats.forEach(chat => {
            chat.addEventListener('click', () => {
                selectChat('group', chat.dataset.id, chat.dataset.name);
            });
        });

        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && currentRoom) {
                const timestamp = new Date().toISOString().replace('T', ' ').slice(0, 19);
                const data = {
                    sender_id: user.id,
                    sender_name: user.name,
                    message: message,
                    timestamp: timestamp,
                    room: currentRoom
                };
                if (currentType === 'private') {
                    data.recipient_id = parseInt(currentId);
                } else {
                    data.group_id = parseInt(currentId);
                }
                socket.emit('message', data);
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendButton.click();
            }
        });

        let typingTimeout;
        messageInput.addEventListener('input', () => {
            if (currentRoom) {
                socket.emit('typing', { sender: user.name, room: currentRoom });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('typing', { sender: '', room: currentRoom });
                }, 1000);
            }
        });

        socket.on('message', (data) => {
            if (data.room === currentRoom) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${data.sender_id == user.id ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    <div class="sender">${data.sender_name || 'Unknown'}</div>
                    <div>${data.message}</div>
                    <div class="timestamp">${data.timestamp}</div>
                `;
                chatBox.appendChild(messageDiv);
                scrollToBottom();
            }
        });

        socket.on('typing', (data) => {
            if (data.room === currentRoom && data.sender && data.sender !== user.name) {
                typingIndicator.textContent = `${data.sender} is typing...`;
            } else {
                typingIndicator.textContent = '';
            }
        });

        scrollToBottom();
    </script>
</body>
</html>